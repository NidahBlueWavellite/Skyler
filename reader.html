<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Skyler — Reader</title>

<style>
html, body {
  margin: 0;
  height: 100%;
}

/* PDF.js viewer iframe */
#viewerFrame {
  width: 100%;
  height: 100%;
  border: none;
}

/* Blur overlay */
#blurOverlay {
  position: fixed;
  inset: 0;
  backdrop-filter: blur(8px);
  background: rgba(13, 42, 58, 0.75);
  display: none;
  z-index: 9999;
  color: #fff;
  font-family: 'Roboto Slab', serif;
}

/* Overlay content */
#blurContent {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #082133;
  padding: 28px 32px;
  border-radius: 14px;
  text-align: center;
  max-width: 420px;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}

#blurContent h2 {
  margin: 0 0 10px;
  font-weight: 700;
}

#blurContent p {
  margin: 0;
  opacity: 0.9;
}

/* Publish-proof stamp */
#stamp {
  position: fixed;
  bottom: 8px;
  right: 12px;
  font-size: 12px;
  opacity: 0.65;
  z-index: 10000;
  pointer-events: none;
  font-family: 'Roboto Slab', serif;
}
</style>
</head>

<body>

<iframe id="viewerFrame"></iframe>

<div id="blurOverlay">
  <div id="blurContent">
    <h2>Preview ends here</h2>
    <p>The remaining pages will be available soon.</p>
  </div>
</div>

<div id="stamp">Last updated: loading…</div>

<script>
const params = new URLSearchParams(window.location.search);

const pdf   = params.get("file");          // required
const mode  = params.get("mode");          // preview | full
const limit = Number(params.get("limit")); // preview pages

if (!pdf) {
  document.body.innerHTML = "No PDF specified.";
  throw new Error("Missing PDF");
}

/* ===============================
   LOAD PDF.js VIEWER
   Adjust path to viewer.html as needed
================================ */

// If viewer.html is in the same folder
// const viewerPath = "viewer.html";

// If viewer.html is inside /web folder (typical PDF.js download)
const viewerPath = "web/viewer.html";

const viewerURL =
  viewerPath +
  "?file=" + encodeURIComponent(pdf) +
  "&disableDownload=true" +
  "&disablePrint=true" +
  "&disableOpenFile=true";

const iframe = document.getElementById("viewerFrame");
iframe.src = viewerURL;

/* ===============================
   SOFT BLUR PREVIEW LOGIC
================================ */
if (mode === "preview" && limit > 0) {
  let locked = false;

  iframe.addEventListener("load", () => {
    const win = iframe.contentWindow;
    const doc = win.document;

    win.addEventListener("scroll", () => {
      if (locked) return;

      const scrollTop = win.scrollY;
      const viewH     = win.innerHeight;
      const fullH     = doc.documentElement.scrollHeight;

      const estimatedPage = Math.ceil((scrollTop + viewH) / (fullH / 20));

      if (estimatedPage > limit) {
        locked = true;

        document.getElementById("blurOverlay").style.display = "flex";

        win.scrollTo({
          top: (fullH / 20) * (limit - 0.3),
          behavior: "smooth"
        });
      }
    });
  });
}

/* ===============================
   GITHUB PUBLISH PROOF
================================ */
fetch("https://api.github.com/repos/NidahBlueWavellite/Skyler/commits/main")
  .then(r => r.json())
  .then(d => {
    const date = new Date(d.commit.committer.date);
    document.getElementById("stamp").textContent =
      "Last updated: " + date.toUTCString();
  })
  .catch(() => {
    document.getElementById("stamp").textContent =
      "Last updated: unavailable";
  });
</script>


</body>
</html>
